# Movies API

API для кинотеатра. Точка входа для всех клиентов.

## Сервисы

Данный API является частью большого сервиса кинотеатра и соответственно взаимодействует с некоторыми частями
этого сервиса (экземпляры данных сервисов должны быть развернуты локольно или на другой машине, все адреса указывается в переменных окружения):

- `Elasticsearch` - ETL-процессы и полнотекстовый поиск: https://github.com/recloud1/new_admin_panel_sprint_3

# Используемые библиотеки

- http: FastAPI
- валидация: Pydantic
- кэш: Redis
- хранилище: Elasticsearch

# Первичная конфигурация

## Необходимые настройки для быстрого старта

Установить переменные среды в `.env` файл по образу и подобию `.env.example`
(там содержатся только базовые настройки, более подробные лежат в `./app/core/config.py`)

## Документация

Для проекта не ведётся отдельная документация, однако для всех роутов автоматически генерируется интерактивная
документация, с которой можно ознакомиться на `/docs` или `/redoc`


# Models или pydantic модели

Для выходной и входящей обработки сущностей используются pydantic модели, представляющие описание формата
данных.

**Все pydantic модели обязательно наследуются от ** `/src/models/core/Model`. Там содержатся базовые
настройки

Для упрощения жизни предлагается следующая иерархия для схем данных:

- `<EntityName>Short` - содержит минимальный набор описывающий полей (обычно это id, название)
- `<EntityName>Update` - набор параметров для обновления данных в сущности
- `<EntityName>Create(Update)` - набор параметров для создания сущности
- `<EntityName>Bare(Create)` - набор полей для выдачи объекта (bare – т.е. без вложенных сущностей)
- `<EntityName>Full(Bare)` – набор полей со всеми вложенными сущностями, максимальный набор параметров
- `<EntityName>List(ListModel)` – список из объектов с любым вариантом сущности внутри

Структура не на все случаи жизни (в исключительных ситуациях можно не наследовать модели в предложенном
порядке), но крайне рекомендуется соблюдать (**особенно не следует плодить кучу моделей для одной сущности**)

## Выдача списков

Для выдачи списков объектов **обязательно использовать `/src/models/core/ListModel` и наследовать,
указывая для поля `data` список со своей конкретной сущностью

# Тесты
Для тестирования API применяются интеграционные тесты. Взаимодействие происходит между `FastAPI`, `Elasticsearch`
и `Redis`.

## Запуск тестов
Первым дело необходимо добавить файл `.env` в соответствие с файлом `.env.example` в директорию `tests/functional`.
Далее есть два сценария запусков тестов:
1. все запускать в `docker` - для этого необходимо поднять все сервисы доступные в `test/functional/docker-compose.yml`
- Profit: смотри результат в контейнере `pytest`.
2. запускать через `docker` только интеграции: т.е. нужно поднять только `elasticsearch`, `redis`
(в данном случае можно не поднимать `fastapi` - так можно производить debug) + можно поднять `fastapi` по-желанию.
PS: если поднимаешь контейнер с `fastapi` и что-то меняешь в приложении - не забудь пересобрать контейнер :) 
